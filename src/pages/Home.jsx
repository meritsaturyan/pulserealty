// src/pages/Home.jsx
import React, { useEffect, useMemo, useRef, useState } from 'react';
import styled, { css } from 'styled-components';
import RecentProperties from '../components/RecentProperties';
import AdvancedFilters from '../components/AdvancedFilters';
import { useOutletContext } from 'react-router-dom';


const REGIONS = {
  Yerevan: {
    label: { en: 'Yerevan', ru: '–ï—Ä–µ–≤–∞–Ω', hy: '‘µ÷Ä÷á’°’∂' },
    towns: [
      { key: 'Ajapnyak', label: { en: 'Ajapnyak', ru: '–ê—á–∞–ø–Ω—è–∫', hy: '‘±’ª’°÷É’∂’µ’°’Ø' } },
      { key: 'Avan', label: { en: 'Avan', ru: '–ê–≤–∞–Ω', hy: '‘±’æ’°’∂' } },
      { key: 'Davtashen', label: { en: 'Davtashen', ru: '–î–∞–≤—Ç–∞—à–µ–Ω', hy: '‘¥’°’æ’©’°’∑’•’∂' } },
      { key: 'Erebuni', label: { en: 'Erebuni', ru: '–≠—Ä–µ–±—É–Ω–∏', hy: '‘∑÷Ä’•’¢’∏÷Ç’∂’´' } },
      { key: 'Kanaker-Zeytun', label: { en: 'Kanaker-Zeytun', ru: '–ö–∞–Ω–∞–∫–µ—Ä-–ó–µ–π—Ç—É–Ω', hy: '’î’°’∂’°÷Ñ’•’º-‘∂’•’µ’©’∏÷Ç’∂' } },
      { key: 'Kentron', label: { en: 'Kentron', ru: '–ö–µ–Ω—Ç—Ä–æ–Ω', hy: '‘ø’•’∂’ø÷Ä’∏’∂' } },
      { key: 'Malatia-Sebastia', label: { en: 'Malatia-Sebastia', ru: '–ú–∞–ª–∞—Ç–∏—è-’ç–µ–±–∞—Å—Ç–∏—è', hy: '’Ñ’°’¨’°’©’´’°-’ç’•’¢’°’Ω’ø’´’°' } },
      { key: 'Nor Nork', label: { en: 'Nor Nork', ru: '–ù–æ—Ä-–ù–æ—Ä–∫', hy: '’Ü’∏÷Ä ’Ü’∏÷Ä÷Ñ' } },
      { key: 'Nork-Marash', label: { en: 'Nork-Marash', ru: '–ù–æ—Ä–∫-–ú–∞—Ä–∞—à', hy: '’Ü’∏÷Ä÷Ñ-’Ñ’°÷Ä’°’∑' } },
      { key: 'Nubarashen', label: { en: 'Nubarashen', ru: '–ù—É–±–∞—Ä–∞—à–µ–Ω', hy: '’Ü’∏÷Ç’¢’°÷Ä’°’∑’•’∂' } },
      { key: 'Shengavit', label: { en: 'Shengavit', ru: '’á–µ–Ω’£–∞–≤–∏—Ç', hy: '’á’•’∂’£’°’æ’´’©' } },
      { key: 'Arabkir', label: { en: 'Arabkir', ru: '–ê—Ä–∞–±–∫–∏—Ä', hy: '‘±÷Ä’°’¢’Ø’´÷Ä' } },
    ],
  },

  Aragatsotn: {
    label: { en: 'Aragatsotn', ru: '–ê—Ä–∞–≥–∞—Ü–æ—Ç–Ω', hy: '‘±÷Ä’°’£’°’Æ’∏’ø’∂' },
    towns: [
      { key: 'Ashtarak', label: { en: 'Ashtarak', ru: '–ê—à—Ç–∞—Ä–∞–∫', hy: '‘±’∑’ø’°÷Ä’°’Ø' } },
      { key: 'Aparan', label: { en: 'Aparan', ru: '–ê–ø–∞—Ä–∞–Ω', hy: '‘±’∫’°÷Ä’°’∂' } },
      { key: 'Talin', label: { en: 'Talin', ru: '–¢–∞–ª–∏–Ω', hy: '‘π’°’¨’´’∂' } },
      { key: 'Oshakan', label: { en: 'Oshakan', ru: '–û—à–∞–∫–∞–Ω', hy: '’ï’∑’°’Ø’°’∂' } },
      { key: 'Tsaghkahovit', label: { en: 'Tsaghkahovit', ru: '–¶–∞—Ö–∫–∞–æ–≤–∏—Ç', hy: '‘æ’°’≤’Ø’°’∞’∏’æ’´’ø' } },
    ],
  },

  Ararat: {
    label: { en: 'Ararat', ru: '–ê—Ä–∞—Ä–∞—Ç', hy: '‘±÷Ä’°÷Ä’°’ø' },
    towns: [
      { key: 'Artashat', label: { en: 'Artashat', ru: '–ê—Ä—Ç–∞—à–∞—Ç', hy: '‘±÷Ä’ø’°’∑’°’ø' } },
      { key: 'Masis', label: { en: 'Masis', ru: '–ú–∞—Å–∏—Å', hy: '’Ñ’°’Ω’´’Ω' } },
      { key: 'Vedi', label: { en: 'Vedi', ru: '–í–µ–¥–∏', hy: '’é’•’§’´' } },
      { key: 'Ararat', label: { en: 'Ararat', ru: '–ê—Ä–∞—Ä–∞—Ç', hy: '‘±÷Ä’°÷Ä’°’ø' } },
      { key: 'Lusarat', label: { en: 'Lusarat', ru: '–õ—É—Å–∞—Ä–∞—Ç', hy: '‘º’∏÷Ç’Ω’°’º’°’ø' } },
    ],
  },

  Armavir: {
    label: { en: 'Armavir', ru: '–ê—Ä–º–∞–≤–∏—Ä', hy: '‘±÷Ä’¥’°’æ’´÷Ä' },
    towns: [
      { key: 'Armavir', label: { en: 'Armavir', ru: '–ê—Ä–º–∞–≤–∏—Ä', hy: '‘±÷Ä’¥’°’æ’´÷Ä' } },
      { key: 'Echmiadzin', label: { en: 'Vagharshapat (Etchmiadzin)', ru: '–í–∞–≥–∞—Ä—à–∞–ø–∞—Ç (–≠—á–º–∏–∞–¥–∑–∏–Ω)', hy: '’é’°’≤’°÷Ä’∑’°’∫’°’ø (‘∑’ª’¥’´’°’Æ’´’∂)' } },
      { key: 'Metsamor', label: { en: 'Metsamor', ru: '–ú–µ—Ü–∞–º–æ—Ä', hy: '’Ñ’•’Æ’°’¥’∏÷Ä' } },
      { key: 'Baghramyan', label: { en: 'Baghramyan', ru: '–ë–∞–≥—Ä–∞–º—è–Ω', hy: '‘≤’°’≤÷Ä’°’¥’µ’°’∂' } },
    ],
  },

  Gegharkunik: {
    label: { en: 'Gegharkunik', ru: '–ì–µ–≥–∞—Ä–∫—É–Ω–∏–∫', hy: '‘≥’•’≤’°÷Ä÷Ñ’∏÷Ç’∂’´÷Ñ' },
    towns: [
      { key: 'Gavar', label: { en: 'Gavar', ru: '–ì–∞–≤–∞—Ä', hy: '‘≥’°’æ’°’º' } },
      { key: 'Sevan', label: { en: 'Sevan', ru: '–°–µ–≤–∞–Ω', hy: '’ç÷á’°’∂' } },
      { key: 'Vardenis', label: { en: 'Vardenis', ru: '–í–∞—Ä–¥–µ–Ω–∏—Å', hy: '’é’°÷Ä’§’•’∂’´’Ω' } },
      { key: 'Martuni', label: { en: 'Martuni', ru: '–ú–∞—Ä—Ç—É–Ω–∏', hy: '’Ñ’°÷Ä’ø’∏÷Ç’∂’´' } },
      { key: 'Chambarak', label: { en: 'Chambarak', ru: '–ß–∞–º–±–∞—Ä–∞–∫', hy: '’â’°’¥’¢’°÷Ä’°’Ø' } },
    ],
  },

  Lori: {
    label: { en: 'Lori', ru: '–õ–æ—Ä–∏', hy: '‘º’∏’º’´' },
    towns: [
      { key: 'Vanadzor', label: { en: 'Vanadzor', ru: '–í–∞–Ω–∞–¥–∑–æ—Ä', hy: '’é’°’∂’°’±’∏÷Ä' } },
      { key: 'Alaverdi', label: { en: 'Alaverdi', ru: '–ê–ª–∞–≤–µ—Ä–¥–∏', hy: '‘±’¨’°’æ’•÷Ä’§’´' } },
      { key: 'Stepanavan', label: { en: 'Stepanavan', ru: '–°—Ç–µ–ø–∞–Ω–∞–≤–∞–Ω', hy: '’ç’ø’•÷É’°’∂’°’æ’°’∂' } },
      { key: 'Spitak', label: { en: 'Spitak', ru: '–°–ø–∏—Ç–∞–∫', hy: '’ç’∫’´’ø’°’Ø' } },
      { key: 'Tashir', label: { en: 'Tashir', ru: '–¢–∞—à–∏—Ä', hy: '’è’°’∑’´÷Ä' } },
    ],
  },

  Kotayk: {
    label: { en: 'Kotayk', ru: '–ö–æ—Ç–∞–π–∫', hy: '‘ø’∏’ø’°’µ÷Ñ' },
    towns: [
      { key: 'Abovyan', label: { en: 'Abovyan', ru: '–ê–±–æ–≤—è–Ω', hy: '‘±’¢’∏’æ’µ’°’∂' } },
      { key: 'Hrazdan', label: { en: 'Hrazdan', ru: '–†–∞–∑–¥–∞–Ω', hy: '’Ä÷Ä’°’¶’§’°’∂' } },
      { key: 'Charentsavan', label: { en: 'Charentsavan', ru: '–ß–∞—Ä–µ–Ω—Ü–∞–≤–∞–Ω', hy: '’â’°÷Ä’•’∂÷Å’°’æ’°’∂' } },
      { key: 'Byureghavan', label: { en: 'Byureghavan', ru: '–ë—é—Ä–µ–≥–∞–≤–∞–Ω', hy: '‘≤’µ’∏÷Ç÷Ä’•’≤’°’æ’°’∂' } },
      { key: 'Tsaghkadzor', label: { en: 'Tsaghkadzor', ru: '–¶–∞—Ö–∫–∞–¥–∑–æ—Ä', hy: '‘æ’°’≤’Ø’°’±’∏÷Ä' } },
    ],
  },

  Shirak: {
    label: { en: 'Shirak', ru: '’á–∏—Ä–∞–∫', hy: '’á’´÷Ä’°’Ø' },
    towns: [
      { key: 'Gyumri', label: { en: 'Gyumri', ru: '–ì—é–º—Ä–∏', hy: '‘≥’µ’∏÷Ç’¥÷Ä’´' } },
      { key: 'Artik', label: { en: 'Artik', ru: '–ê—Ä—Ç–∏–∫', hy: '‘±÷Ä’©’´’Ø' } },
      { key: 'Akhuryan', label: { en: 'Akhuryan', ru: '–ê—Ö—É—Ä—è–Ω', hy: '‘±’≠’∏÷Ç÷Ä’µ’°’∂' } },
      { key: 'Maralik', label: { en: 'Maralik', ru: '–ú–∞—Ä–∞–ª–∏–∫', hy: '’Ñ’°÷Ä’°’¨’´’Ø' } },
    ],
  },

  Syunik: {
    label: { en: 'Syunik', ru: '–°—é–Ω–∏–∫', hy: '’ç’µ’∏÷Ç’∂’´÷Ñ' },
    towns: [
      { key: 'Kapan', label: { en: 'Kapan', ru: '–ö–∞–ø–∞–Ω', hy: '‘ø’°’∫’°’∂' } },
      { key: 'Goris', label: { en: 'Goris', ru: '–ì–æ—Ä–∏—Å', hy: '‘≥’∏÷Ä’´’Ω' } },
      { key: 'Sisian', label: { en: 'Sisian', ru: '–°–∏—Å–∏–∞–Ω', hy: '’ç’´’Ω’´’°’∂' } },
      { key: 'Meghri', label: { en: 'Meghri', ru: '–ú–µ–≥—Ä–∏', hy: '’Ñ’•’≤÷Ä’´' } },
      { key: 'Agarak', label: { en: 'Agarak', ru: '–ê–≥–∞—Ä–∞–∫', hy: '‘±’£’°÷Ä’°’Ø' } },
    ],
  },

  VayotsDzor: {
    label: { en: 'Vayots Dzor', ru: '–í–∞–π–æ—Ü –î–∑–æ—Ä', hy: '’é’°’µ’∏÷Å ’±’∏÷Ä' },
    towns: [
      { key: 'Yeghegnadzor', label: { en: 'Yeghegnadzor', ru: '–ï—Ö–µ–≥–Ω–∞–¥–∑–æ—Ä', hy: '‘µ’≤’•’£’∂’°’±’∏÷Ä' } },
      { key: 'Vayk', label: { en: 'Vayk', ru: '–í–∞–π–∫', hy: '’é’°’µ÷Ñ' } },
      { key: 'Jermuk', label: { en: 'Jermuk', ru: '–î–∂–µ—Ä–º—É–∫', hy: '’ã’•÷Ä’¥’∏÷Ç’Ø' } },
    ],
  },

  Tavush: {
    label: { en: 'Tavush', ru: '–¢–∞–≤—É—à', hy: '’è’°’æ’∏÷Ç’∑' },
    towns: [
      { key: 'Ijevan', label: { en: 'Ijevan', ru: '–ò–¥–∂–µ–≤–∞–Ω', hy: '‘ª’ª÷á’°’∂' } },
      { key: 'Dilijan', label: { en: 'Dilijan', ru: '–î–∏–ª–∏–∂–∞–Ω', hy: '‘¥’´’¨’´’ª’°’∂' } },
      { key: 'Berd', label: { en: 'Berd', ru: '–ë–µ—Ä–¥', hy: '‘≤’•÷Ä’§' } },
      { key: 'Noyemberyan', label: { en: 'Noyemberyan', ru: '–ù–æ–µ–º–±–µ—Ä—è–Ω', hy: '’Ü’∏’µ’•’¥’¢’•÷Ä’µ’°’∂' } },
    ],
  },
};


const regionKeys = Object.keys(REGIONS);
const getRegionLabel = (key, lang) => REGIONS[key]?.label?.[lang] || key;
const getTownLabel = (regionKey, townKey, lang) => {
  const list = REGIONS[regionKey]?.towns || [];
  if (!list.length) return townKey;
  if (typeof list[0] === 'string') return townKey;
  const item = list.find(x => x.key === townKey);
  return (item?.label?.[lang]) || townKey;
};


const TEXT = {
  en: {
    heroTitle: 'Search Your Next Home',
    heroSubtitle: '',
    forRent: 'For Rent',
    forSale: 'For Sale',
    propertyLabel: 'Search',
    keywordsPlaceholder: 'Search...',
    regionLabel: 'Region',
    districtsLabel: 'Districts',
    townsLabel: 'Towns/Villages',
    propertyType: 'Property Type',
    apartment: 'Apartment',
    house: 'House',
    villa: 'Commercial Space',
    land: 'Land',
    dealType: 'Deal Type',
    advanceFilter: 'Advance Filter',
    searchBtn: 'Search Property',
    callUs: 'üìû Call Us:',
    openTelegram: 'Open Telegram Chat',
    statsTitle: 'Our Statistics',
    housesSold: 'Houses Sold',
    homesRented: 'Homes Rented',
    happyClients: 'Happy Clients',
    managedProperties: 'Managed Properties',
    clear: 'Clear',
    apply: 'OK',
  },
  ru: {
    heroTitle: '–ù–∞–π–¥–∏—Ç–µ —Å–≤–æ–π –Ω–æ–≤—ã–π –¥–æ–º',
    heroSubtitle: '',
    forRent: '–ê—Ä–µ–Ω–¥–∞',
    forSale: '–ü—Ä–æ–¥–∞–∂–∞',
    propertyLabel: '–ü–æ–∏—Å–∫',
    keywordsPlaceholder: '–ò—Å–∫–∞—Ç—å...',
    regionLabel: '–û–±–ª–∞—Å—Ç—å',
    districtsLabel: '–†–∞–π–æ–Ω—ã',
    townsLabel: '–ì–æ—Ä–æ–¥–∞/—Å—ë–ª–∞',
    propertyType: '–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏',
    apartment: '–ö–≤–∞—Ä—Ç–∏—Ä–∞',
    house: '–î–æ–º',
    villa: '–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ',
    land: '–ó–µ–º–ª—è',
    dealType: '–¢–∏–ø —Å–¥–µ–ª–∫–∏',
    advanceFilter: '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä',
    searchBtn: '–ò—Å–∫–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã',
    callUs: 'üìû –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º:',
    openTelegram: '–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç –≤ Telegram',
    statsTitle: '–ù–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
    housesSold: '–ü—Ä–æ–¥–∞–Ω–æ –¥–æ–º–æ–≤',
    homesRented: '–°–¥–∞–Ω–æ –≤ –∞—Ä–µ–Ω–¥—É',
    happyClients: '–î–æ–≤–æ–ª—å–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã',
    managedProperties: '–û–±—ä–µ–∫—Ç–æ–≤ –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏',
    clear: '–û—á–∏—Å—Ç–∏—Ç—å',
    apply: '–û–ö',
  },
  hy: {
    heroTitle: '‘≥’ø’•’õ÷Ñ ’Å’•÷Ä ’∞’°’ª’∏÷Ä’§ ’ø’∏÷Ç’∂’®',
    heroSubtitle: '',
    forRent: '’é’°÷Ä’±’∏’æ',
    forSale: '’é’°’≥’°’º÷Ñ',
    propertyLabel: '’à÷Ä’∏’∂’∏÷Ç’¥',
    keywordsPlaceholder: '’à÷Ä’∏’∂’•’¨...',
    regionLabel: '’Ñ’°÷Ä’¶',
    districtsLabel: '’é’°÷Ä’π’°’Ø’°’∂ ’∑÷Ä’ª’°’∂’∂’•÷Ä',
    townsLabel: '’î’°’≤’°÷Ñ’∂’•÷Ä/’£’µ’∏÷Ç’≤’•÷Ä',
    propertyType: '‘≥’∏÷Ç’µ÷Ñ’´ ’ø’•’Ω’°’Ø',
    apartment: '‘≤’∂’°’Ø’°÷Ä’°’∂',
    house: '’è’∏÷Ç’∂',
    villa: '‘ø’∏’¥’•÷Ä÷Å’´’∏’∂ ’ø’°÷Ä’°’Æ÷Ñ',
    land: '’Ä’∏’≤',
    dealType: '‘≥’∏÷Ä’Æ’°÷Ä÷Ñ’´ ’ø’•’Ω’°’Ø',
    advanceFilter: '‘º÷Ä’°÷Å’∏÷Ç÷Å’´’π ÷Ü’´’¨’ø÷Ä',
    searchBtn: '’ì’∂’ø÷Ä’•’¨ ’£’∏÷Ç’µ÷Ñ',
    callUs: 'üìû ‘∂’°’∂’£’°’∞’°÷Ä’•÷Ñ ’¥’•’¶’ù',
    openTelegram: '‘≤’°÷Å’•’¨ Telegram ’π’°’ø’®',
    statsTitle: '’Ñ’•÷Ä ’æ’´’≥’°’Ø’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’®',
    housesSold: '’é’°’≥’°’º’æ’°’Æ ’ø’∂’•÷Ä',
    homesRented: '’è÷Ä’æ’°’Æ ’æ’°÷Ä’±’∏’æ',
    happyClients: '‘≥’∏’∞ ’∞’°’≥’°’≠’∏÷Ä’§’∂’•÷Ä',
    managedProperties: '‘ø’°’º’°’æ’°÷Ä’æ’∏’≤ ’£’∏÷Ç’µ÷Ñ’•÷Ä',
    clear: '’Ñ’°÷Ñ÷Ä’•’¨',
    apply: '‘º’°’æ',
  },
};

const Hero = styled.div`
  height: 100vh;
  color: white;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 0 20px;
  position: relative;

  ${({ $withBackground }) => $withBackground && css`
    background-image: url('https://images.unsplash.com/photo-1501183638710-841dd1904471');
    background-size: cover;
    background-position: center;

    &::before {
      content: '';
      position: absolute;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 0;
    }

    > * { position: relative; z-index: 1; }
  `}
`;


const Tabs = styled.div`
  display: flex;
  gap: 30px;
  margin-top: 20px;
  font-weight: bold;

  span {
    cursor: pointer;
    color: white;
    position: relative;
    padding-bottom: 4px;
    transition: color 0.3s;

    &.active { color: #f0ae00; }
    &.active::after {
      content: "";
      position: absolute;
      bottom: -4px; left: 0;
      width: 100%; height: 2px;
      background-color: #f0ae00;
    }
  }
`;

const SearchWrapper = styled.div`
  background: white;
  padding: 20px;
  border-radius: 10px;
  display: flex;
  align-items: flex-start;
  gap: 12px; /* –±—ã–ª–æ 15px ‚Äî —á—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  width: min(1100px, calc(100% - 48px));
  margin: 20px auto 0;

  /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö/—É–∑–∫–∏—Ö) */
  flex-wrap: wrap;

  /* –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ ‚Äî –í–°–Å –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */
  @media (min-width: 1024px){
    flex-wrap: nowrap;
  }

  justify-content: center;
  position: relative;
  z-index: 1;
`;



const InputBlock = styled.div`
  display: flex;
  flex-direction: column;
  position: relative; /* –¥–ª—è dropdown */
  min-width: 140px;   /* –±—ã–ª–æ 180px */
  flex: 1 1 140px;    /* –º–æ–∂–Ω–æ —É–∂–∏–º–∞—Ç—å—Å—è/—Ä–∞—Å—Ç–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å—Ç—Ä–æ–∫–∏ */
`;

const Label = styled.label`
  color: #8E90A6; font-size: 12px; margin-bottom: 4px;
`;
const Input = styled.input`
  border: none; outline: none; padding: 8px 12px; background: #fff; color: #1A3D4D; font-size: 14px;
`;
const Select = styled.select`
  border: none; outline: none; padding: 8px 12px; background: #fff; color: #1A3D4D; font-size: 14px;
`;

const ButtonBlock = styled(InputBlock)`
  flex: 0 0 auto;          /* –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å, –¥–µ—Ä–∂–∞—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º */
  justify-content: flex-start;
`;
const FakeLabel = styled(Label)` visibility: hidden; `;
const CheckboxWrapper = styled.div` display: flex; flex-direction: column; gap: 10px; margin-top: 8px; `;
const CheckboxLabel = styled.label`
  display: flex; align-items: center; gap: 12px; font-size: 16px; font-weight: 500; color: #555; cursor: pointer;
  input[type="checkbox"]{
    width:20px;height:20px;appearance:none;border:2px solid #ccc;border-radius:2px;background:#fff;position:relative;transition:.2s;
    &:checked{background:#f0ae00;border-color:#f0ae00;}
    &:checked::after{content:'';position:absolute;top:3px;left:6px;width:5px;height:10px;border:solid #fff;border-width:0 2px 2px 0;transform:rotate(45deg);}
  }
`;

const FilterButton = styled.button`
  display:flex; align-items:center; border:none; background:none; color:#1A3D4D;
  font-size:14px; cursor:pointer; padding:8px 12px; white-space:nowrap;
`;
const SearchButton = styled.button`
  padding:10px 20px; background:#f0ae00; color:#fff; border:none; border-radius:4px; font-weight:bold; white-space:nowrap;
`;


const DesktopFilters = styled.div`
  max-height: ${({ $visible }) => ($visible ? '1500px' : '0')};
  opacity: ${({ $visible }) => ($visible ? '1' : '0')};
  overflow: hidden;
  transition: max-height .6s ease, opacity .4s ease;
  width: 100%;
  display: flex;
  justify-content: center;

  @media (max-width: 768px){ display:none; }
`;


const DesktopPanel = styled.div`
  width: 100%;
  max-width: 760px; /* –±—ã–ª–æ 1100px */
  padding: 8px 0 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
`;


const DesktopActions = styled.div`
  display: flex;
  justify-content: flex-end;
`;

const CloseBtn = styled.button`
  padding: 6px 10px;
  background: #f3f4f6;
  border: 1px solid #e5e7eb;
  color: #111;
  border-radius: 6px;
  cursor: pointer;
`;

const Backdrop = styled.div`
  display:none;
  @media (max-width:768px){
    display:${({ $open }) => ($open ? 'block' : 'none')};
    position:fixed; inset:0; background:transparent; z-index:9;
  }
`;


const MobileDrawer = styled.div`
  display:none;

  @media (max-width:768px){
    display:${({ $open }) => ($open ? 'flex' : 'none')};
    position:fixed; left:0; right:0; bottom:0;
    width:100%;
    max-height:72vh;
    background:#fff;
    z-index:10;
    border-radius:16px 16px 0 0;
    box-shadow: 0 -8px 24px rgba(0,0,0,.15);
    padding:12px 16px max(16px, env(safe-area-inset-bottom));
    overflow-y:auto;
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
    flex-direction:column;
  }
`;

const Grabber = styled.div`
  width:44px; height:4px; border-radius:2px; background:#E5E7EB; margin:4px auto 10px;
`;

const DrawerActions = styled.div`
  display:flex; gap:12px; margin-top:12px;
  button{ flex:1; }
`;


const PseudoSelect = styled.button`
  display:flex; align-items:center; justify-content:space-between;
  padding:8px 12px; background:#fff; color:#1A3D4D; font-size:14px;
  border:none; outline:none; cursor:pointer;
  min-width:140px;            /* –±—ã–ª–æ 180px */
  border-radius:4px;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
  &:after{ content:'‚ñæ'; margin-left:12px; opacity:.7; }
`;


const TownsDropdown = styled.div`
  position:absolute; top: calc(100% + 6px); left: 0;
  width: min(360px, 90vw);
  max-height: 260px;
  background:#fff; border-radius:8px;
  box-shadow: 0 12px 28px rgba(0,0,0,.12), 0 2px 6px rgba(0,0,0,.08);
  padding:10px;
  overflow:auto;
  z-index: 20;
`;

const DropActions = styled.div`
  display:flex; gap:8px; margin-top:8px;
  button{ flex:1; padding:8px 10px; border-radius:6px; cursor:pointer; }
  .apply{ background:#f0ae00; color:#fff; border:none; }
  .clear{ background:#f3f4f6; border:1px solid #e5e7eb; color:#111; }
`;


const StatsWrapper = styled.section` max-width:1100px; margin:40px auto 0; padding:0 20px; `;
const StatsTitle = styled.h3` text-align:center; color:#1A3D4D; font-size:28px; margin:0 0 16px; `;
const StatsGrid = styled.div`
  display:grid; grid-template-columns:repeat(4, minmax(160px,1fr)); gap:16px;
  @media (max-width:900px){ grid-template-columns:repeat(2,1fr); }
  @media (max-width:520px){ grid-template-columns:1fr; }
`;
const StatCard = styled.div` background:#f0f4f7; border-radius:10px; padding:20px; text-align:center; `;
const StatNumber = styled.div` font-size:32px; font-weight:800; color:#f0ae00; margin-bottom:8px; `;
const StatLabel = styled.div` font-size:16px; color:#1A3D4D; `;

const ContactsSection = styled.div`
  background:#f9f9f9; padding:30px; text-align:center; margin-top:40px; font-size:16px; color:#1A3D4D;
  h3{ margin-bottom:10px; white-space: nowrap; }
  a{ color:#f0ae00; text-decoration:none; font-weight:bold; }
  @media (max-width:420px){ h3{ font-size:18px; } }
`;

const Home = ({ propertiesRef: propRef }) => {
  const { propertiesRef: ctxRef } = useOutletContext() ?? {};
  const propertiesRef = propRef || ctxRef;

  const [activeTab, setActiveTab] = useState('sale');
  const [showFilters, setShowFilters] = useState(false);
  const [selectedRegion, setSelectedRegion] = useState('');
  const [selectedTowns, setSelectedTowns] = useState([]);
  const [keywords, setKeywords] = useState('');


  const [openTowns, setOpenTowns] = useState(false);
  const townsRef = useRef(null);

  const searchAreaRef = useRef(null);

  const [lang, setLang] = useState(
    document.documentElement.lang || localStorage.getItem('lang') || 'hy'
  );

  useEffect(() => {
    const el = document.documentElement;
    const observer = new MutationObserver(muts => {
      for (const m of muts) {
        if (m.type === 'attributes' && m.attributeName === 'lang') {
          setLang(el.lang || 'hy');
        }
      }
    });
    observer.observe(el, { attributes: true });
    if (!el.lang) el.lang = localStorage.getItem('lang') || 'hy';
    return () => observer.disconnect();
  }, []);

  useEffect(() => {
    const onFocus = () => {
      const saved = localStorage.getItem('lang') || 'hy';
      if (saved !== lang) setLang(saved);
    };
    window.addEventListener('focus', onFocus);
    return () => window.removeEventListener('focus', onFocus);
  }, [lang]);

  const t = useMemo(() => TEXT[lang] || TEXT.hy, [lang]);


  useEffect(() => {
    const isMobile = window.matchMedia('(max-width: 768px)').matches;
    if (isMobile && showFilters) {
      const prev = document.body.style.overflow;
      document.body.dataset.prevOverflow = prev || '';
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = document.body.dataset.prevOverflow || '';
    }
    return () => { document.body.style.overflow = document.body.dataset.prevOverflow || ''; };
  }, [showFilters]);


  useEffect(() => {
    const handler = (e) => {
      if (!showFilters) return;
      if (window.matchMedia('(max-width:768px)').matches) return;
      if (searchAreaRef.current && !searchAreaRef.current.contains(e.target)) {
        setShowFilters(false);
      }
    };
    document.addEventListener('mousedown', handler);
    return () => document.removeEventListener('mousedown', handler);
  }, [showFilters]);


  useEffect(() => {
    const onKey = (e) => { if (e.key === 'Escape') setShowFilters(false); };
    document.addEventListener('keydown', onKey);
    return () => document.removeEventListener('keydown', onKey);
  }, []);

  const handleTownToggle = (town) => {
    setSelectedTowns(prev => prev.includes(town) ? prev.filter(t => t !== town) : [...prev, town]);
  };

  const clearTowns = () => setSelectedTowns([]);

  const townsArray = useMemo(() => {
    if (!selectedRegion) return [];
    const raw = REGIONS[selectedRegion]?.towns || [];
    if (!raw.length) return [];
    if (typeof raw[0] === 'string') return raw.map(x => ({ key: x, label: x }));
    return raw.map(x => ({ key: x.key, label: x.label?.[lang] || x.key }));
  }, [selectedRegion, lang]);

  const summaryTowns = useMemo(() => {
    if (!selectedRegion) return '';
    if (!selectedTowns.length) return selectedRegion === 'Yerevan' ? t.districtsLabel : t.townsLabel;
    const labels = selectedTowns.map(k => getTownLabel(selectedRegion, k, lang));
    if (labels.length <= 2) return labels.join(', ');
    return `${labels.slice(0, 2).join(', ')} +${labels.length - 2}`;
  }, [selectedRegion, selectedTowns, lang, t]);

  const scrollToResults = () => { if (propertiesRef?.current) propertiesRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' }); };

  return (
    <>
      <Hero $withBackground>
        <h1>{t.heroTitle}</h1>
        {t.heroSubtitle && <p>{t.heroSubtitle}</p>}
        <Tabs>
          <span
            className={activeTab === 'sale' ? 'active' : ''}
            onClick={() => setActiveTab('sale')}
          >
            {t.forSale}
          </span>
          <span
            className={activeTab === 'rent' ? 'active' : ''}
            onClick={() => setActiveTab('rent')}
          >
            {t.forRent}
          </span>
        </Tabs>


        { }
        <div ref={searchAreaRef} style={{ width: '100%' }}>
          <SearchWrapper>
            <InputBlock>
              <Label>{t.propertyLabel}</Label>
              <Input
                placeholder={t.keywordsPlaceholder}
                value={keywords}
                onChange={(e) => setKeywords(e.target.value)}
                onKeyDown={(e) => { if (e.key === 'Enter') scrollToResults(); }}
              />
            </InputBlock>

            <InputBlock>
              <Label>{t.regionLabel}</Label>
              <Select
                value={selectedRegion}
                onChange={(e) => {
                  setSelectedRegion(e.target.value);
                  setSelectedTowns([]);
                  setOpenTowns(false);
                }}
              >
                <option value="">{t.regionLabel}</option>
                {regionKeys.map(r => (
                  <option key={r} value={r}>{getRegionLabel(r, lang)}</option>
                ))}
              </Select>
            </InputBlock>

            {selectedRegion && (
              <InputBlock ref={townsRef}>
                <Label>{selectedRegion === 'Yerevan' ? t.districtsLabel : t.townsLabel}</Label>
                <PseudoSelect type="button" onClick={() => setOpenTowns(v => !v)}>
                  <span>{summaryTowns}</span>
                </PseudoSelect>

                {openTowns && (
                  <TownsDropdown>
                    <div style={{ fontSize: 12, color: '#8E90A6', margin: '0 0 6px' }}>
                      {selectedRegion === 'Yerevan' ? t.districtsLabel : t.townsLabel}
                    </div>
                    <CheckboxWrapper style={{ marginTop: 0 }}>
                      {townsArray.map(({ key, label }) => (
                        <CheckboxLabel key={key}>
                          <input type="checkbox" checked={selectedTowns.includes(key)} onChange={() => handleTownToggle(key)} />
                          {label}
                        </CheckboxLabel>
                      ))}
                    </CheckboxWrapper>
                    <DropActions>
                      <button type="button" className="clear" onClick={clearTowns}>{t.clear}</button>
                      <button type="button" className="apply" onClick={() => setOpenTowns(false)}>{t.apply}</button>
                    </DropActions>

                  </TownsDropdown>
                )}
              </InputBlock>
            )}

            <InputBlock>
              <Label>{t.propertyType}</Label>
              <Select>
                <option>{t.apartment}</option>
                <option>{t.house}</option>
                <option>{t.villa}</option>
                <option>{t.land}</option>
              </Select>
            </InputBlock>

            <InputBlock>
              <Label>{t.dealType}</Label>
              <Select value={activeTab} onChange={(e) => setActiveTab(e.target.value)}>
                <option value="sale">{t.forSale}</option>
                <option value="rent">{t.forRent}</option>
              </Select>

            </InputBlock>

            { }
            <ButtonBlock>
              <FakeLabel>_</FakeLabel>
              <FilterButton
                onClick={() => setShowFilters(v => !v)}
                aria-expanded={showFilters}
                aria-controls="desktop-advanced-filters"
              >
                &#9776;&nbsp;{t.advanceFilter}
              </FilterButton>
            </ButtonBlock>

            <ButtonBlock>
              <FakeLabel>_</FakeLabel>
              <SearchButton onClick={scrollToResults}>{t.searchBtn}</SearchButton>
            </ButtonBlock>
          </SearchWrapper>

          { }
          <DesktopFilters $visible={showFilters} id="desktop-advanced-filters">
            <DesktopPanel>
              <DesktopActions>
                <CloseBtn type="button" onClick={() => setShowFilters(false)}>‚úï Close</CloseBtn>
              </DesktopActions>
              <AdvancedFilters />
            </DesktopPanel>
          </DesktopFilters>
        </div>

        { }
        <Backdrop $open={showFilters} onClick={() => setShowFilters(false)} />
        <MobileDrawer $open={showFilters} onClick={(e) => e.stopPropagation()}>
          <Grabber />
          <AdvancedFilters />
          <DrawerActions>
            <SearchButton onClick={() => { setShowFilters(false); scrollToResults(); }}>{t.searchBtn}</SearchButton>
            <button
              style={{ border: '1px solid #e5e7eb', background: '#fff', color: '#1A3D4D', borderRadius: 4, fontWeight: 600 }}
              onClick={() => setShowFilters(false)}
            >
              Close
            </button>
          </DrawerActions>
        </MobileDrawer>
      </Hero>

      { }
      { }
      <div
        id="properties"
        data-scroll="properties"
        ref={propertiesRef}
        style={{ scrollMarginTop: '120px' }}
      >
        <RecentProperties filterText={keywords} />
      </div>



      { }
      <StatsWrapper>
        <StatsTitle>{t.statsTitle}</StatsTitle>
        <StatsGrid>
          <StatCard><StatNumber>320+</StatNumber><StatLabel>{t.housesSold}</StatLabel></StatCard>
          <StatCard><StatNumber>210+</StatNumber><StatLabel>{t.homesRented}</StatLabel></StatCard>
          <StatCard><StatNumber>500+</StatNumber><StatLabel>{t.happyClients}</StatLabel></StatCard>
          <StatCard><StatNumber>75+</StatNumber><StatLabel>{t.managedProperties}</StatLabel></StatCard>
        </StatsGrid>
      </StatsWrapper>

      { }
      <ContactsSection>
        <h3>{t.callUs} +374 94444940</h3>
        <p>üí¨ Live Chat: <a href="https://t.me/your_support_bot" target="_blank" rel="noopener noreferrer">{t.openTelegram}</a></p>
      </ContactsSection>
    </>
  );
};

export default Home;








































